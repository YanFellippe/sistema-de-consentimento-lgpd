<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 1rem; background: #f9f9f9; }
  h1 { color: #333; font-size: 1.75rem; margin: 0; }
  .consent-card {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }
  .consent-info { flex: 1; min-width: 0; }
  .consent-info h3 { margin: 0 0 0.5rem 0; font-size: 1.1rem; }
  .consent-info .status { font-size: 0.9rem; color: #555; word-wrap: break-word; }
  .consent-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
  .btn { padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; white-space: nowrap; }
  .btn-grant { background: #28a745; color: white; }
  .btn-revoke { background: #dc3545; color: white; }
  .btn-info { background: #17a2b8; color: white; }
  .btn-secondary { background: #6c757d; color: white; }
  .btn:disabled { background: #ccc; cursor: not-allowed; }
  .btn:hover:not(:disabled) { opacity: 0.9; }
  .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .status-granted { color: #28a745; }
  .status-revoked { color: #dc3545; }
  .status-undefined { color: #6c757d; }
  .notice { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
  .alert { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
  .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap; }
  .user-info-section { flex: 1; min-width: 200px; }
  .user-info-section p { margin: 0.5rem 0; word-break: break-word; }
  
  @media (max-width: 768px) {
    body { margin: 0.5rem; }
    h1 { font-size: 1.5rem; }
    .page-header { flex-direction: column; align-items: stretch; }
    .header-actions { width: auto; }
    .header-actions .btn { flex: 0 1 auto; text-align: center; }
    .consent-card { flex-direction: column; align-items: stretch; padding: 0.75rem; }
    .consent-info { max-width: 100%; }
    .consent-actions { width: 100%; margin-top: 0.75rem; }
    .consent-actions form { flex: 1; }
    .consent-actions .btn { width: 100%; }
  }
  
  @media (max-width: 480px) {
    h1 { font-size: 1.25rem; }
    .consent-info h3 { font-size: 1rem; }
    .consent-info .status { font-size: 0.85rem; }
    .btn { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
    .notice, .alert { font-size: 0.9rem; padding: 0.75rem; }
  }
</style>

<% if notice %>
  <div class="notice"><%= notice %></div>
<% end %>

<% if alert %>
  <div class="alert"><%= alert %></div>
<% end %>

<div class="page-header">
  <div class="user-info-section">
    <h1>Gerenciamento de Consentimentos</h1>
    <p><b>Usuário:</b> <%= @user.name %> (<%= @user.email %>)</p>
  </div>
  <div class="header-actions">
    <%= link_to "Ver Histórico", consents_history_path(@user.id), class: "btn btn-info" %>
    <%= link_to "Voltar", users_path, class: "btn btn-secondary" %>
  </div>
</div>

<hr>

<% @purposes.each do |purpose| %>

  <% consent = @consents_hash[purpose.id] %>

  <div class="consent-card">
    <div class="consent-info">
      <h3><%= purpose.name %></h3>

      <div class="status">
        <strong>Status:</strong>
        <% if consent&.granted? %>
          <span class="status-granted">CONCEDIDO</span> (em: <%= consent.granted_at.strftime('%d/%m/%Y %H:%M') %>)
        <% elsif consent&.revoked? %>
          <span class="status-revoked">REVOGADO</span> (em: <%= consent.revoked_at.strftime('%d/%m/%Y %H:%M') %>)
        <% else %>
          <span class="status-undefined">NÃO DEFINIDO</span>
        <% end %>
      </div>
    </div>

    <div class="consent-actions">
      <%= button_to "Conceder", 
          consents_toggle_path, 
          method: :post,
          class: "btn btn-grant",
          disabled: (consent && consent.granted?), 
          params: { 
            user_id: @user.id, 
            purpose_id: purpose.id, 
            status: 'granted' 
          } %>

      <%= button_to "Revogar", 
          consents_toggle_path, 
          method: :post,
          class: "btn btn-revoke",
          disabled: (!consent || !consent.granted?), 
          params: { 
            user_id: @user.id, 
            purpose_id: purpose.id, 
            status: 'revoked' 
          } %>
    </div>
  </div>
<% end %>
